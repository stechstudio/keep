<?php

// TODO: Re-enable these tests when orchestra/testbench is added back
// These tests require a full Laravel environment to work properly

skip('Laravel integration tests require orchestra/testbench - skipping until implemented');

beforeEach(function () {
    $this->app = new class extends Container {
        private string $environment = 'testing';
        
        public function environment(): string {
            return $this->environment;
        }
        
        public function setEnvironment(string $env): void {
            $this->environment = $env;
        }
    };
    
    $this->app->singleton('config', fn() => new class {
        private array $data = [];
        public function get($key, $default = null) { return $this->data[$key] ?? $default; }
        public function set($key, $value) { $this->data[$key] = $value; }
    });
    
    // Set required APP_KEY config
    $this->app['config']->set('app.key', 'base64:' . base64_encode(random_bytes(32)));
    
    $this->provider = new SecretsServiceProvider($this->app);
});

it('generates correct cache file path for mapped environments', function () {
    $this->app->setEnvironment('local');
    
    $this->app['config']->set('keep.stage_environment_mapping', [
        'development' => 'local',
        'production' => 'production',
    ]);
    
    // Mock storage_path function
    if (!function_exists('storage_path')) {
        function storage_path($path = '') {
            return '/tmp/storage/' . $path;
        }
    }
    
    $this->provider->register();
    
    // Use reflection to test protected method (temporary until we refactor)
    $reflection = new ReflectionClass($this->provider);
    $method = $reflection->getMethod('getCacheFilePath');
    $method->setAccessible(true);
    
    $result = $method->invoke($this->provider);
    
    expect($result)->toBe('/tmp/storage/cache/development.keep.php');
});

it('throws exception when current environment has no stage mapping', function () {
    // Mock app()->environment() to return unmapped environment
    $this->app->bind('app', fn() => new class {
        public function environment() { return 'testing'; }
    });
    
    $this->app['config']->set('keep.stage_environment_mapping', [
        'development' => 'local',
        'production' => 'production',
    ]);
    
    $this->provider->register();
    
    // Use reflection to test protected method
    $reflection = new ReflectionClass($this->provider);
    $method = $reflection->getMethod('getCacheFilePath');
    $method->setAccessible(true);
    
    expect(fn() => $method->invoke($this->provider))
        ->toThrow(RuntimeException::class, "No Keep stage mapped to Laravel environment 'testing'");
});

it('uses correct stage mapping for different environments', function () {
    $testCases = [
        ['environment' => 'local', 'expected_stage' => 'development'],
        ['environment' => 'staging', 'expected_stage' => 'staging'],
        ['environment' => 'production', 'expected_stage' => 'production'],
    ];
    
    foreach ($testCases as $case) {
        // Set environment directly on our extended container
        $this->app->setEnvironment($case['environment']);
        
        $this->app['config']->set('keep.stage_environment_mapping', [
            'development' => 'local',
            'staging' => 'staging', 
            'production' => 'production',
        ]);
        
        $provider = new SecretsServiceProvider($this->app);
        $provider->register();
        
        // Use reflection to test protected method
        $reflection = new ReflectionClass($provider);
        $method = $reflection->getMethod('getCacheFilePath');
        $method->setAccessible(true);
        
        $result = $method->invoke($provider);
        
        expect($result)->toBe("/tmp/storage/cache/{$case['expected_stage']}.keep.php");
    }
});